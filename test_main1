import random


class Ship:
    def __init__(self, coordinates, ship_size):
        self.coordinates = coordinates
        self.ship_size = ship_size
        self.hits = []

    def hit(self, coordinate):
        self.hits.append(coordinate)

    def is_sunk(self):
        return all(coordinate in self.hits for coordinate in self.coordinates)


class Board:
    def __init__(self, size):
        self.size = size
        self.ships = []
        self.grid = [['О' for _ in range(size)] for _ in range(size)]
        self.hits = []
        self.misses = []

    @staticmethod
    def valid_enter(x, y, x1, y1, coordinates):
        if (x, y) in coordinates:
            raise ValueError("Вы уже выбрали эту координату")
            # break
        if not player_board.is_valid_coordinate((x, y)):
            raise ValueError("Invalid ship placement")
        if player_board.grid[x][y] == '■':
            raise ValueError("В этом месте уже есть корабль")
        for x, y in player_board.get_adjacent_coordinates(x, y):
            # if not x == x1 and y == y1:
            # if not player_board.grid[x][y]:
            if player_board.is_valid_coordinate((x, y)) and player_board.grid[x][y] == '■':  #
                raise ValueError("Корабль должен находиться на расстоянии одной клетки")
            # if not x == x2 and y == y2:
            #     if player_board.grid[x][y] == '■':  # player_board.is_valid_coordinate((x, y)) and
            #         raise ValueError("Ships must be at least one cell apart")
        coordinates.append((x1, y1))
    
    @staticmethod
    def valid_enter_comp(x, y, x1, y1, coordinates):
        if (x, y) in coordinates:
            return False
        if not player_board.is_valid_coordinate((x, y)):
            return
        if player_board.grid[x][y] == '■':
            return False
        for x, y in player_board.get_adjacent_coordinates(x, y):
            if player_board.is_valid_coordinate((x, y)) and player_board.grid[x][y] == '■':  
                return False
        coordinates.append((x1, y1))
        
    def add_ship(self, ship, ship_size):
        try:
            for coordinate in ship.coordinates:
                self.grid[coordinate[0]][coordinate[1]] = '■'
            self.ships.append(ship)
        except ValueError:
            raise ValueError("Так располагать нельзя")

    def is_valid_coordinate(self, coordinate):
        x, y = coordinate
        return 0 <= x < self.size and 0 <= y < self.size

    @staticmethod
    def get_adjacent_coordinates(x, y):
        # x, y = coordinate
        return [(x - 1, y), (x + 1, y), (x, y - 1), (x, y + 1)]

    def is_hit(self, coordinate):
        return coordinate in self.hits

    def is_miss(self, coordinate):
        return coordinate in self.misses

    def record_hit(self, coordinate):
        self.grid[coordinate[0]][coordinate[1]] = 'X'
        self.hits.append(coordinate)

    def record_miss(self, coordinate):
        self.grid[coordinate[0]][coordinate[1]] = 'T'
        self.misses.append(coordinate)

    def display(self):
        print(" | " + " | ".join(str(i + 1) for i in range(self.size)) + " |")
        for i in range(self.size):
            row = "| " + " | ".join(self.grid[i]) + " |"
            print(f"{i + 1} | {row}")


player_board = Board(6)
computer_board = Board(6)


def play_game():
    # Place ships on player board
    player_board.display()
    print("Place your ships:")
    numb_ship = 1
    for ship_size in [1]:  # [3, 2, 2, 1, 1, 1, 1]:
        while True:
            if ship_size == 2 or ship_size == 3:
                try:
                    vert_or_hor = int(input("Вы хотите расположить корабль вертикально (1) или горизонтально (2)?: "))
                    if vert_or_hor == 1:
                        coordinates = []
                        x1, y1 = 0, 0
                        counter = 0
                        y = int(input(f"Enter Y coordinate for ship {numb_ship} of size {ship_size}: ")) - 1
                        if 0 <= y < 6:
                            for i in range(ship_size):
                                x = int(input(f"Enter X coordinate for ship {numb_ship} of size {ship_size}: ")) - 1
                                if 0 <= x < 6:
                                    x1, y1 = x, y
                                    player_board.valid_enter(x, y, x1, y1, coordinates)
                                else:
                                    print("Введите корректное число")
                            ship = Ship(coordinates, ship_size)
                            player_board.add_ship(ship, ship_size)
                            numb_ship += 1
                            player_board.display()
                            break
                        else:
                            print("Введите корректное число")
                    elif vert_or_hor == 2:
                        coordinates = []
                        x = int(input(f"Enter X coordinate for ship {numb_ship} of size {ship_size}: ")) - 1
                        if 0 <= x < 6:
                            for i in range(ship_size):
                                y = int(input(f"Enter Y coordinate for ship {numb_ship} of size {ship_size}: ")) - 1
                                if 0 <= y < 6:
                                    x1, y1 = x, y
                                    player_board.valid_enter(x, y, x1, y1, coordinates)
                                else:
                                    print("Введите корректное число")
                            ship = Ship(coordinates, ship_size)
                            player_board.add_ship(ship, ship_size)
                            numb_ship += 1
                            player_board.display()
                            break
                        else:
                            print("Введите корректное число")
                    else:
                        print("Введите корректное число")
                except ValueError as e:
                    print(e)
            else:
                try:
                    coordinates = []
                    x = int(input(f"Enter X coordinate for ship {numb_ship} of size {ship_size}: ")) - 1
                    y = int(input(f"Enter Y coordinate for ship {numb_ship} of size {ship_size}: ")) - 1
                    if player_board.grid[x][y] == '■':
                        raise ValueError("В этом месте уже есть корабль")
                    coordinates.append((x, y))
                    ship = Ship(coordinates, ship_size)
                    player_board.add_ship(ship, ship_size)
                    numb_ship += 1
                    player_board.display()
                    break
                except ValueError as e:
                    print(e)

    # Place ships on computer board
    print("Комп расставляет корабли")
    for ship_size in [3, 2, 2, 1, 1, 1, 1]:
        while True:
            x = random.randint(0, 5)
            y = random.randint(0, 5)
            direction = random.choice(['horizontal', 'vertical'])
            coordinates = [(x, y)]
            if direction == 'horizontal':
                for i in range(1, ship_size + 1):
                    while True:  # i <= ship_size:
                        if computer_board.is_valid_coordinate((x, y + 1)):
                            x1, y1 = x, y
                            if computer_board.valid_enter_comp(x, y, x1, y1, coordinates):
                                coordinates.append((x, y + 1))
                                # i += 1
                                break 
                            continue
                        else:
                            if computer_board.is_valid_coordinate((x, y - 1)):
                                x1, y1 = x, y
                                if computer_board.valid_enter_comp(x, y, x1, y1, coordinates):
                                    coordinates.append((x, y - 1))
                                    # i += 1
                                    break
                                continue
            else:
                for i in range(1, ship_size + 1):
                    while True:  # i <= ship_size:
                        if computer_board.is_valid_coordinate((x + 1, y)):
                            x1, y1 = x, y
                            if computer_board.valid_enter_comp(x, y, x1, y1, coordinates):
                                coordinates.append((x + 1, y))
                                # i += 1
                                break
                            continue
                        else:
                            if computer_board.is_valid_coordinate((x - 1, y)):
                                x1, y1 = x, y
                                if computer_board.valid_enter_comp(x, y, x1, y1, coordinates):
                                    coordinates.append((x - 1, y))
                                    # i += 1
                                    break
                                continue
            try:
                ship = Ship(coordinates, ship_size)
                computer_board.add_ship(ship, ship_size)
                break
            except ValueError:
                continue
            
    while True:
        print("Player's turn:")
        print("Поле игрока: ")
        player_board.display()
        print("Поле компа: ")
        computer_board.display()
        x = int(input("Enter X coordinate for your attack: ")) - 1
        y = int(input("Enter Y coordinate for your attack: ")) - 1
        if computer_board.is_hit((x, y)) or computer_board.is_miss((x, y)):
            print("You've already attacked that coordinate. Try again.")
            continue
        if computer_board.grid[x][y] == '■':
            print("Hit!")
            computer_board.record_hit((x, y))
            for ship in computer_board.ships:
                if (x, y) in ship.coordinates:
                    ship.hit((x, y))
                    if ship.is_sunk():
                        print("You sank a ship!")
                        computer_board.ships.remove(ship)
                    break
        else:
            print("Miss.")
            computer_board.record_miss((x, y))

        if not computer_board.ships:
            print("Congratulations! You won!")
            break

        print("Computer's turn:")
        while True:
            x = random.randint(0, 5)
            y = random.randint(0, 5)
            if (x, y) not in player_board.hits and (x, y) not in player_board.misses:
                break
        if player_board.grid[x][y] == '■':
            print("You were hit!")
            for ship in player_board.ships:
                if (x, y) in ship.coordinates:
                    ship.hit((x, y))
                    if ship.is_sunk():
                        print("Computer sank one of your ships!")
                        player_board.ships.remove(ship)
                    break
        else:
            print("Computer missed.")
            player_board.record_miss((x, y))
        
        if not player_board.ships:
            print("Game over. You lost.")
            break


if __name__ == "__main__":
    play_game()
